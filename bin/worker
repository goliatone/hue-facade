#!/usr/bin/env node
'use strict';

var Client = require('../lib/client'),
    config = require('../config/hue-facade.json'),
    clients = [], _client;

//Initialize clients
config.bridges.map(function(bridge){
    _client = new Client(bridge);
    process.nextTick(_client.start.bind(_client));
    clients.push(_client);
});

//--expose_gc => global.gc()

//PM2_KILL_TIMEOUT=60000 pm2 start ./bin/worker --name hue-worker
//pm2 sendSignal SIGINT 0|hue-worker <= pm2 will actually restart if we exit.
//pm2 stop 0|hue-worker will send SIGINT and not restart.
process.on('SIGINT', function(){

    clients.map(function(client){
        client.stop();
        _client = client;
    });

    _client.stop().then(function(){
        console.log('CLEAN EXIT');
        process.exit(0);
    }).catch(function(err){
        console.error('ERROR ON EXIT', err.message);
        process.exit(1);
    });

    // process.nextTick(function(){
    //     console.log('CLEAN EXIT');
    //     process.exit(0);
    // });
});
